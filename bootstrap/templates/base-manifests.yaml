{{- if .Values.baseManifests.enabled }} # Only render this Application if baseManifests is enabled.
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: base-manifests # These are the base manifests ArgoCD Application, used for ClusterIssuer, Namespaces, etc.
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io # Foreground cascade deletion of resources. This ensures that when the Application is deleted, all associated resources are also cleaned up.
spec:
  project: default
  destination:
    server: {{ .Values.spec.destination.server }}
    # This namespace is set to 'default' because some of the manifests are cluster-wide resources
    # (like ClusterIssuer) or have their own namespace defined within the manifest.
    namespace: default 
  source:
    # Source repository for the base manifests
    repoURL: {{ .Values.spec.source.repoURL }}
    targetRevision: {{ .Values.spec.source.targetRevision }}
    # Indicates Argo CD to sync the manifests from this directory
    path: bootstrap/manifests 
    directory:
      recurse: true # Process all YAML files in the directory
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    # Namespace creation is managed separately in the manifests. Avoid Argo CD trying to create them.
      - CreateNamespace=false 
  # Assign sync wave to ensure proper ordering during synchronization
  info:
    - name: 'Sync Wave'
      value: {{ .Values.baseManifests.syncWave | quote }}
{{- end }} 