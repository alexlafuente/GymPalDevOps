{{- if .Values.baseManifests.enabled }} # Only render this Application if baseManifests is enabled.
apiVersion: {{ .Values.apiVersion }}
kind: {{ .Values.kind }}
metadata:
  name: {{ .Values.baseManifests.metadata.name }} # These are the base manifests ArgoCD Application, used for ClusterIssuer, Namespaces, etc.
  namespace: {{ .Values.metadata.namespace }} # Namespace where Argo CD is running
  annotations:
    # Define sync wave for base manifests deployment. This is required to ensure it deploys before applications depending on it.
    argocd.argoproj.io/sync-wave: {{ .Values.baseManifests.annotations.syncWave | quote }} # Sync wave for ordering. Quote used to ensure it's treated as a string.
  finalizers: {{ .Values.metadata.finalizers | join "\n - " }} # Foreground cascade deletion of resources. This ensures that when the Application is deleted, all associated resources are also cleaned up.
spec:
  project: {{ .Values.spec.project }}
  destination:
    server: {{ .Values.spec.destination.server }}
    # This namespace is set to 'default' because some of the manifests are cluster-wide resources
    # (like ClusterIssuer) or have their own namespace defined within the manifest.
    namespace: default 
  source:
    # Source repository for the base manifests
    repoURL: {{ .Values.baseManifests.spec.source.repoURL }}
    targetRevision: {{ .Values.baseManifests.spec.source.targetRevision }}
    # Indicates Argo CD to sync the manifests from this directory
    path: {{ .Values.baseManifests.spec.source.path }}
    directory: {{ .toYaml .Values.baseManifests.spec.source.directory | nindent 6 }}
  syncPolicy:
    automated:
      prune: {{ .Values.spec.syncPolicy.automated.prune }} # Delete resources that are no longer defined in Git
      selfHeal: {{ .Values.spec.syncPolicy.automated.selfHeal }} # Automatically sync if the live state deviates from Git
    syncOptions: {{ .Values.baseManifests.spec.syncPolicy.syncOptions | join "\n - " }} # Create the target namespace if it doesn't exist
{{- end }} 